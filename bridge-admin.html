<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ü§ñ Automated Webinar Bridge Generator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      color: white;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .navigation {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .nav-link {
      color: #fff;
      text-decoration: none;
      padding: 8px 16px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      transition: all 0.3s;
    }

    .nav-link:hover {
      background: rgba(255,255,255,0.2);
    }

    .nav-current {
      color: #fff;
      font-weight: 600;
    }

    .main-content {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 30px;
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .forms-list {
      border-right: 2px solid #f0f0f0;
      padding-right: 30px;
    }

    .forms-list h2 {
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-item {
      padding: 15px;
      margin-bottom: 10px;
      border: 2px solid #f0f0f0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .form-item:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }

    .form-item.active {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }

    .form-editor {
      padding-left: 30px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 12px;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: #5a6fd8;
      transform: translateY(-1px);
    }

    .btn-success {
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 12px;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 15px;
      padding: 30px;
      max-width: 80%;
      max-height: 80%;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }

    .code-preview {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-all;
      overflow-wrap: break-word;
      max-height: 400px;
      overflow-y: auto;
      overflow-x: auto;
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }

    .code-actions {
      display: flex;
      gap: 10px;
    }

    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      z-index: 2000;
      transform: translateX(100%);
      transition: transform 0.3s;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.success {
      background: #28a745;
    }

    .toast.error {
      background: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h1>ü§ñ Bridge Admin Login</h1>
    <p>Enter password to access the automated bridge generator</p>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter admin password">
      <small>Default password: <strong>admin123</strong></small>
    </div>
    <button class="btn-primary" style="width: 100%; margin-top: 10px;" id="loginBtn">Login</button>
  </div>

  <!-- Main Dashboard -->
  <div id="adminDashboard" class="container hidden">
    <div class="header">
      <h1>ü§ñ Automated Webinar Bridge</h1>
      <p>Generate automated bridges for existing WebinarFuel embeds</p>
    </div>
    
    <!-- Navigation -->
    <div class="navigation">
      <a href="/" class="nav-link">
        ‚Üê üìù Standard Registration Forms
      </a>
      <span style="color: rgba(255,255,255,0.6);">|</span>
      <span class="nav-current">ü§ñ Automated Webinar Bridge</span>
      <span style="color: rgba(255,255,255,0.6); font-size: 14px; margin-left: auto;">Generate automated bridges for existing WebinarFuel embeds</span>
    </div>

    <div class="main-content">
      <!-- Forms List -->
      <div class="forms-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>üìã Saved Bridges</h2>
          <button class="btn-primary btn-small" id="newFormBtn">+ New</button>
        </div>
        <div id="formsList"></div>
      </div>

      <!-- Form Editor -->
      <div class="form-editor">
        <div id="editorContent"></div>
      </div>
    </div>
  </div>

  <!-- Code Preview Modal -->
  <div id="codeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Generated Bridge Code</h2>
        <button class="close-btn" id="closeCodeBtn">√ó</button>
      </div>
      <div class="code-preview" id="codePreview"></div>
      <div class="code-actions">
        <button class="btn-success" id="copyCodeBtn">üìã Copy to Clipboard</button>
        <button class="btn-primary" id="downloadCodeBtn">‚¨áÔ∏è Download HTML</button>
      </div>
    </div>
  </div>

  <script>
    // App State
    const app = {
      currentForm: null,
      forms: [],
      DEFAULT_PASSWORD: 'admin123',
      STORAGE_KEYS: {
        PASSWORD: 'wf_admin_password',
        FORMS: 'wf_forms',
        LOGGED_IN: 'wf_logged_in',
        ACTIVE_FORM: 'wf_active_form'
      }
    };

    // Initialize
    document.addEventListener('DOMContentLoaded', async function() {
      await loadForms();
      checkAuth();
      setupEventListeners();
    });

    function setupEventListeners() {
      document.getElementById('loginBtn').addEventListener('click', login);
      document.getElementById('loginPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
      document.getElementById('newFormBtn').addEventListener('click', createNewForm);
      document.getElementById('closeCodeBtn').addEventListener('click', closeCodeModal);
      document.getElementById('copyCodeBtn').addEventListener('click', copyCode);
      document.getElementById('downloadCodeBtn').addEventListener('click', downloadCode);
    }

    // Authentication
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem(app.STORAGE_KEYS.LOGGED_IN);
      if (isLoggedIn === 'true') {
        showDashboard();
      } else {
        showLogin();
      }
    }

    function login() {
      const password = document.getElementById('loginPassword').value;
      const storedPassword = localStorage.getItem(app.STORAGE_KEYS.PASSWORD) || app.DEFAULT_PASSWORD;
      
      if (password === storedPassword) {
        sessionStorage.setItem(app.STORAGE_KEYS.LOGGED_IN, 'true');
        showDashboard();
        showToast('Welcome back! üëã', 'success');
      } else {
        showToast('Incorrect password ‚ùå');
        document.getElementById('loginPassword').value = '';
      }
    }

    function showLogin() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('loginPassword').value = '';
    }

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminDashboard').classList.remove('hidden');
      renderFormsList();
      
      const activeFormId = localStorage.getItem(app.STORAGE_KEYS.ACTIVE_FORM);
      if (activeFormId && app.forms.find(f => f.id === activeFormId)) {
        loadForm(activeFormId);
      } else if (app.forms.length > 0) {
        loadForm(app.forms[0].id);
      } else {
        showEmptyEditor();
      }
    }

    // Forms Management
    async function loadForms() {
      try {
        const response = await fetch('api.php?action=get');
        const result = await response.json();
        
        if (result.success && result.data.forms) {
          app.forms = result.data.forms.filter(form => form.form_type === 'automated_webinar') || [];
        } else {
          app.forms = [];
        }
      } catch (error) {
        console.error('Error loading forms:', error);
        app.forms = [];
      }
    }

    async function saveForms() {
      try {
        const response = await fetch('api.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'save',
            data: { forms: app.forms }
          })
        });
        
        const result = await response.json();
        if (!result.success) {
          console.error('Failed to save forms:', result.error);
        }
      } catch (error) {
        console.error('Error saving forms:', error);
      }
    }

    async function createNewForm() {
      const newForm = {
        id: Date.now().toString(),
        name: 'New Automated Bridge ' + (app.forms.length + 1),
        form_type: 'automated_webinar',
        infusionsoft_action: '',
        infusionsoft_xid: '',
        wf_embed_code: '',
        button_text: 'Register Now',
        consent_message: 'I consent to receive SMS messages about this webinar and future marketing communications. Message and data rates may apply. Reply STOP to opt-out.',
        consent_id: 'inf_option_SMSConsent',
        consent_value: '3872'
      };
      
      app.forms.push(newForm);
      await saveForms();
      await loadForm(newForm.id);
      renderFormsList();
      showToast('New automated bridge created! üéâ', 'success');
    }

    async function loadForm(formId) {
      app.currentForm = app.forms.find(f => f.id === formId);
      if (app.currentForm) {
        localStorage.setItem(app.STORAGE_KEYS.ACTIVE_FORM, formId);
        await renderFormEditor();
      }
    }

    function renderFormsList() {
      const container = document.getElementById('formsList');
      if (app.forms.length === 0) {
        container.innerHTML = '<p style="color: #666; font-style: italic;">No automated bridges yet. Click "+ New" to create one.</p>';
        return;
      }

      container.innerHTML = app.forms.map(form => `
        <div class="form-item ${app.currentForm?.id === form.id ? 'active' : ''}" onclick="loadForm('${form.id}')">
          <div style="font-weight: 600; margin-bottom: 5px;">${escapeHtml(form.name)}</div>
          <div style="font-size: 12px; opacity: 0.7;">Automated Bridge</div>
        </div>
      `).join('');
    }

    async function renderFormEditor() {
      if (!app.currentForm) {
        showEmptyEditor();
        return;
      }

      document.getElementById('editorContent').innerHTML = `
        <h2>ü§ñ Automated Bridge Configuration</h2>
        <p style="margin-bottom: 20px; color: #666;">Generate a bridge that automatically captures WebinarFuel registrations and sends them to Infusionsoft</p>
        
        <div class="form-group">
          <label>Bridge Name</label>
          <input type="text" id="formName" value="${escapeHtml(app.currentForm.name)}" placeholder="e.g., My Webinar Bridge">
        </div>

        <div class="form-group">
          <label>WebinarFuel Embed Code</label>
          <textarea id="wfEmbedCode" rows="4" placeholder="Paste your complete WebinarFuel embed script here...">${escapeHtml(app.currentForm.wf_embed_code || '')}</textarea>
          <small>Paste the entire &lt;script&gt; tag from WebinarFuel</small>
        </div>

        <div class="form-group">
          <label>Paste Infusionsoft Form HTML</label>
          <textarea id="infusionsoftFormPaste" rows="4" placeholder="Paste your full Infusionsoft form HTML (or hosted form snippet) here..."></textarea>
          <div style="display: flex; gap: 10px; align-items: center; margin-top: 8px;">
            <button class="btn-primary btn-small" type="button" onclick="extractInfusionsoftFromPaste()">üîç Extract Details</button>
            <small id="infusionsoftExtractStatus" style="opacity: 0.75;"></small>
          </div>
          <small>We'll auto-fill Action URL, XID, and try to detect the SMS consent checkbox if present.</small>
        </div>

        <div class="form-group">
          <label>Infusionsoft Action URL</label>
          <input type="text" id="infusionsoftAction" value="${escapeHtml(app.currentForm.infusionsoft_action)}" 
                 placeholder="https://yv932.infusionsoft.com/app/form/process/xxx">
          <small>The action URL from your Infusionsoft web form</small>
        </div>

        <div class="form-group">
          <label>Infusionsoft XID</label>
          <input type="text" id="infusionsoftXid" value="${escapeHtml(app.currentForm.infusionsoft_xid)}" 
                 placeholder="e.g., ab12cd34ef56gh78">
          <small>The XID from your Infusionsoft web form</small>
        </div>

        <div class="form-group">
          <label>Button Text</label>
          <input type="text" id="buttonText" value="${escapeHtml(app.currentForm.button_text)}" 
                 placeholder="Register Now">
        </div>

        <div class="form-group">
          <label>SMS Consent Message</label>
          <textarea id="consentMessage" rows="3" placeholder="SMS consent message...">${escapeHtml(app.currentForm.consent_message)}</textarea>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 30px;">
          <button class="btn-primary" onclick="saveCurrentForm()">üíæ Save Bridge</button>
          <button class="btn-success" onclick="generateCode()">üöÄ Generate Code</button>
          <button class="btn-primary btn-small" onclick="deleteForm()" style="background: #dc3545; margin-left: auto;">üóëÔ∏è Delete</button>
        </div>
      `;
    }

    function showEmptyEditor() {
      document.getElementById('editorContent').innerHTML = `
        <div style="text-align: center; color: #666; padding: 60px 20px;">
          <h2>ü§ñ Automated Webinar Bridge Generator</h2>
          <p style="margin: 20px 0;">Create bridges that automatically capture WebinarFuel registrations and send them to Infusionsoft with SMS consent.</p>
          <button class="btn-primary" onclick="createNewForm()">+ Create New Bridge</button>
        </div>
      `;
    }

    // Form Operations
    async function saveCurrentForm() {
      if (!app.currentForm) return;

      // Extract WebinarFuel embed ID from the code
      const embedCode = document.getElementById('wfEmbedCode').value;
      let embedId = '';
      
      const match = embedCode.match(/id:\s*['"]([^'"]+)['"]/);
      if (match) {
        embedId = match[1];
      }

      app.currentForm.name = document.getElementById('formName').value;
      app.currentForm.wf_embed_code = embedCode;
      app.currentForm.wf_embed_id = embedId;
      app.currentForm.infusionsoft_action = document.getElementById('infusionsoftAction').value;
      app.currentForm.infusionsoft_xid = document.getElementById('infusionsoftXid').value;
      app.currentForm.button_text = document.getElementById('buttonText').value;
      app.currentForm.consent_message = document.getElementById('consentMessage').value;

      await saveForms();
      renderFormsList();
      showToast('Bridge saved successfully! üíæ', 'success');
    }

    async function generateCode() {
      if (!app.currentForm) return;

      // Save current form data first
      await saveCurrentForm();

      const embedCode = app.currentForm.wf_embed_code;
      const action = app.currentForm.infusionsoft_action;
      const xid = app.currentForm.infusionsoft_xid;

      if (!embedCode) {
        showToast('Please enter WebinarFuel embed code ‚ùå');
        return;
      }

      if (!action || !xid) {
        showToast('Please enter Infusionsoft action URL and XID ‚ùå');
        return;
      }

      const code = generateBridgeCode(app.currentForm);
      document.getElementById('codePreview').textContent = code;
      document.getElementById('codeModal').classList.add('active');
    }

    // Extract Infusionsoft details from pasted HTML
    function extractInfusionsoftFromPaste() {
      const statusEl = document.getElementById('infusionsoftExtractStatus');
      const paste = (document.getElementById('infusionsoftFormPaste')?.value || '').trim();
      if (!paste) {
        statusEl.textContent = 'Nothing to extract.';
        statusEl.style.color = '#b00';
        return;
      }

      // Create a sandbox to parse pasted HTML
      const tmp = document.createElement('div');
      tmp.innerHTML = paste;

      // Find form and action
      const formEl = tmp.querySelector('form');
      const action = formEl?.getAttribute('action') || '';

      // Try to find inf_form_xid hidden input
      let xid = '';
      const xidInput = tmp.querySelector('input[name="inf_form_xid"]');
      if (xidInput) xid = xidInput.getAttribute('value') || '';

      // Consent field detection: look for checkbox likely used for SMS consent
      // Heuristics: input[type=checkbox] whose name begins with 'inf_option' or contains 'Consent'
      let consentId = app.currentForm?.consent_id || 'inf_option_SMSConsent';
      let consentValue = app.currentForm?.consent_value || '';
      const consentCandidate = tmp.querySelector('input[type="checkbox"][name^="inf_option"], input[type="checkbox"][name*="Consent" i]');
      if (consentCandidate) {
        consentId = consentCandidate.getAttribute('name') || consentId;
        consentValue = consentCandidate.getAttribute('value') || consentValue || '1';
      }

      // Update inputs in the editor
      if (action) document.getElementById('infusionsoftAction').value = action;
      if (xid) document.getElementById('infusionsoftXid').value = xid;

      // Update app state immediately so Generate Code uses it
      if (app.currentForm) {
        if (action) app.currentForm.infusionsoft_action = action;
        if (xid) app.currentForm.infusionsoft_xid = xid;
        app.currentForm.consent_id = consentId;
        app.currentForm.consent_value = consentValue;
      }

      // Feedback
      const parts = [];
      if (action) parts.push('Action URL');
      if (xid) parts.push('XID');
      if (consentId) parts.push('Consent: ' + consentId + (consentValue ? '=' + consentValue : ''));
      statusEl.textContent = parts.length ? ('Extracted ' + parts.join(', ')) : 'No recognizable fields found.';
      statusEl.style.color = parts.length ? '#0a0' : '#b00';
    }

    function generateBridgeCode(form) {
      const formId = 'inf_form_' + form.infusionsoft_xid;
      
      return '<!-- WebinarFuel Embed -->\n' +
        form.wf_embed_code + '\n\n' +
        '<!-- Hidden Infusionsoft Form -->\n' +
        '<div style="display: none;">\n' +
        '  <form accept-charset="UTF-8"\n' +
        '        action="' + form.infusionsoft_action + '"\n' +
        '        class="infusion-form"\n' +
        '        id="' + formId + '"\n' +
        '        method="POST">\n' +
        '    \n' +
        '    <input name="inf_form_xid" type="hidden" value="' + form.infusionsoft_xid + '" />\n' +
        '    <input name="inf_form_name" type="hidden" value="WebinarBridge_' + form.infusionsoft_xid + '" />\n' +
        '    <input name="infusionsoft_version" type="hidden" value="1.70.0.794081" />\n\n' +
        '    <input name="inf_field_FirstName" type="hidden" />\n' +
        '    <input name="inf_field_LastName" type="hidden" />\n' +
        '    <input name="inf_field_Email" type="hidden" />\n' +
        '    <input name="inf_field_Phone1" type="hidden" />\n\n' +
        '    <!-- SMS Consent Checkbox -->\n' +
        '    <input id="' + form.consent_id + '_bridge" name="' + form.consent_id + '" type="checkbox" value="' + form.consent_value + '" />\n' +
        '  </form>\n' +
        '</div>\n\n' +
        '<script>\n' +
        'document.addEventListener(\'DOMContentLoaded\', function () {\n' +
        '  console.log("üöÄ WebinarFuel to Infusionsoft bridge initialized");\n\n' +
        '  // Watch for WebinarFuel registration form submission\n' +
        '  function watchForRegistration() {\n' +
        '    const observer = new MutationObserver(() => {\n' +
        '      // Look for WebinarFuel registration form\n' +
        '      const wfForm = document.querySelector(\'.wf_registration_form form, .wf-registration-form form, [class*="registration"] form\');\n' +
        '      \n' +
        '      if (wfForm) {\n' +
        '        console.log("üìã WebinarFuel registration form found");\n' +
        '        \n' +
        '        // Add event listener to form submission\n' +
        '        wfForm.addEventListener(\'submit\', function(e) {\n' +
        '          console.log("üìù WebinarFuel form submitted, capturing data...");\n' +
        '          \n' +
        '          // Extract registration data\n' +
        '          const firstName = wfForm.querySelector(\'input[name*="first"], input[name*="First"], input[placeholder*="First"]\')?.value || \'\';\n' +
        '          const lastName = wfForm.querySelector(\'input[name*="last"], input[name*="Last"], input[placeholder*="Last"]\')?.value || \'\';\n' +
        '          const email = wfForm.querySelector(\'input[type="email"], input[name*="email"], input[placeholder*="email"]\')?.value || \'\';\n' +
        '          const phone = wfForm.querySelector(\'input[type="tel"], input[name*="phone"], input[placeholder*="phone"]\')?.value || \'\';\n' +
        '          \n' +
        '          console.log("üìä Captured data:", { firstName, lastName, email, phone });\n' +
        '          \n' +
        '          // Submit to Infusionsoft after a short delay\n' +
        '          setTimeout(() => {\n' +
        '            submitToInfusionsoft(firstName, lastName, email, phone);\n' +
        '          }, 1000);\n' +
        '        });\n' +
        '        \n' +
        '        observer.disconnect();\n' +
        '      }\n' +
        '    });\n' +
        '    \n' +
        '    observer.observe(document.body, { childList: true, subtree: true });\n' +
        '  }\n\n' +
        '  function submitToInfusionsoft(firstName, lastName, email, phone) {\n' +
        '    console.log("üì§ Submitting to Infusionsoft...");\n' +
        '    \n' +
        '    const form = document.getElementById(\'' + formId + '\');\n' +
        '    if (!form) {\n' +
        '      console.error("‚ùå Infusionsoft form not found");\n' +
        '      return;\n' +
        '    }\n\n' +
        '    // Populate hidden form fields\n' +
        '    const setField = (name, value) => {\n' +
        '      const field = form.querySelector(\'[name="\' + name + \'"]\');\n' +
        '      if (field && value) {\n' +
        '        field.value = value;\n' +
        '        console.log("‚úÖ Set " + name + ":", value);\n' +
        '      }\n' +
        '    };\n\n' +
        '    setField(\'inf_field_FirstName\', firstName);\n' +
        '    setField(\'inf_field_LastName\', lastName);\n' +
        '    setField(\'inf_field_Email\', email);\n' +
        '    setField(\'inf_field_Phone1\', phone);\n\n' +
        '    // Set SMS consent to checked (user registered, so consent is implied)\n' +
        '    const smsCheckbox = form.querySelector(\'input[id="' + form.consent_id + '_bridge"]\');\n' +
        '    if (smsCheckbox) {\n' +
        '      smsCheckbox.checked = true;\n' +
        '      console.log("‚úÖ SMS consent checkbox checked");\n' +
        '    }\n\n' +
        '    try {\n' +
        '      // Submit form using hidden iframe to avoid page redirect\n' +
        '      const iframe = document.createElement("iframe");\n' +
        '      iframe.style.display = "none";\n' +
        '      iframe.name = "hiddenFrame";\n' +
        '      document.body.appendChild(iframe);\n' +
        '      \n' +
        '      form.target = "hiddenFrame";\n' +
        '      form.submit();\n' +
        '      \n' +
        '      console.log("üéâ Successfully submitted to Infusionsoft via hidden iframe!");\n' +
        '      \n' +
        '      // Clean up iframe after a short delay\n' +
        '      setTimeout(() => {\n' +
        '        document.body.removeChild(iframe);\n' +
        '      }, 3000);\n' +
        '    } catch (error) {\n' +
        '      console.error("‚ùå Infusionsoft submission failed:", error);\n' +
        '    }\n' +
        '  }\n\n' +
        '  // Start watching for registration\n' +
        '  watchForRegistration();\n' +
        '});\n' +
    '<\\/script>';
    }

    async function deleteForm() {
      if (!app.currentForm) return;
      
      if (confirm('Are you sure you want to delete this bridge?')) {
        app.forms = app.forms.filter(f => f.id !== app.currentForm.id);
        await saveForms();
        
        // Load another form or show empty editor
        if (app.forms.length > 0) {
          await loadForm(app.forms[0].id);
        } else {
          app.currentForm = null;
          showEmptyEditor();
        }
        
        renderFormsList();
        showToast('Bridge deleted successfully üóëÔ∏è');
      }
    }

    // Code Modal Operations
    function closeCodeModal() {
      document.getElementById('codeModal').classList.remove('active');
    }

    async function copyCode() {
      const code = document.getElementById('codePreview').textContent;
      try {
        await navigator.clipboard.writeText(code);
        showToast('Code copied to clipboard! üìã', 'success');
      } catch (err) {
        showToast('Failed to copy code ‚ùå');
      }
    }

    function downloadCode() {
      const code = document.getElementById('codePreview').textContent;
      const filename = (app.currentForm?.name || 'webinar-bridge').toLowerCase().replace(/[^a-z0-9]/g, '-') + '.html';
      
      const blob = new Blob([code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Code downloaded! ‚¨áÔ∏è', 'success');
    }

    // Utility Functions
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => toast.classList.add('show'), 100);
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => document.body.removeChild(toast), 300);
      }, 3000);
    }

    // Global functions for inline event handlers
    window.saveCurrentForm = saveCurrentForm;
    window.generateCode = generateCode;
    window.deleteForm = deleteForm;
    window.loadForm = loadForm;
    window.createNewForm = createNewForm;
    window.extractInfusionsoftFromPaste = extractInfusionsoftFromPaste;
  </script>
</body>
</html>