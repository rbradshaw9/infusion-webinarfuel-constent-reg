<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webinar Form Generator - Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    /* Login Screen */
    .login-container {
      max-width: 400px;
      margin: 100px auto;
      background: white;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }

    .login-container h1 {
      color: #1f2937;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .login-container p {
      color: #6b7280;
      margin-bottom: 30px;
    }

    /* Admin Dashboard */
    .admin-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px 30px;
      border-radius: 16px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: #1f2937;
      font-size: 24px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
    }

    .main-content {
      display: grid;
      grid-template-columns: 350px 1fr;
      gap: 30px;
    }

    .forms-list {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .forms-list h2 {
      color: #1f2937;
      font-size: 18px;
      margin-bottom: 15px;
    }

    .form-item {
      padding: 15px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .form-item:hover {
      border-color: #667eea;
      background: #f9fafb;
    }

    .form-item.active {
      border-color: #667eea;
      background: #eef2ff;
    }

    .form-item h3 {
      color: #1f2937;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .form-item p {
      color: #6b7280;
      font-size: 13px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #9ca3af;
    }

    .form-editor {
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }

    .form-editor h2 {
      color: #1f2937;
      font-size: 20px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #374151;
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
      font-family: 'Courier New', monospace;
    }

    .form-group small {
      display: block;
      color: #6b7280;
      margin-top: 5px;
      font-size: 12px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #e5e7eb;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      font-family: inherit;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-success {
      background: #10b981;
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 13px;
    }

    /* Code Preview Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      padding: 20px;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .modal-header h2 {
      color: #1f2937;
      font-size: 22px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: #6b7280;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .close-btn:hover {
      background: #f3f4f6;
    }

    .code-preview {
      background: #1f2937;
      color: #e5e7eb;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      margin-bottom: 20px;
      max-height: 500px;
    }

    .code-actions {
      display: flex;
      gap: 10px;
    }

    .hidden {
      display: none !important;
    }

    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: #1f2937;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 2000;
      animation: slideIn 0.3s ease;
    }

    .toast.success {
      background: #10b981;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .section-divider {
      border-top: 2px solid #e5e7eb;
      margin: 30px 0;
      padding-top: 30px;
    }

    .section-title {
      color: #667eea;
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-container">
    <h1>üöÄ Admin Login</h1>
    <p>Enter password to access the form generator</p>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter admin password">
      <small>Default password: <strong>admin123</strong></small>
    </div>
    <button class="btn-primary" onclick="login()" style="width: 100%; margin-top: 10px;">Login</button>
  </div>

  <!-- Admin Dashboard -->
  <div id="adminDashboard" class="admin-container hidden">
    <div class="header">
      <h1>üìù Webinar Form Generator</h1>
      <div class="header-actions">
        <button class="btn-secondary btn-small" onclick="openSettings()">‚öôÔ∏è Settings</button>
        <button class="btn-secondary btn-small" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="main-content">
      <!-- Forms List -->
      <div class="forms-list">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h2>üìã Saved Forms</h2>
          <button class="btn-primary btn-small" onclick="createNewForm()">+ New</button>
        </div>
        <div id="formsList"></div>
      </div>

      <!-- Form Editor -->
      <div class="form-editor">
        <div id="editorContent"></div>
      </div>
    </div>
  </div>

  <!-- Code Preview Modal -->
  <div id="codeModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üìã Generated Embed Code</h2>
        <button class="close-btn" onclick="closeCodeModal()">√ó</button>
      </div>
      <div class="code-preview" id="codePreview"></div>
      <div class="code-actions">
        <button class="btn-success" onclick="copyCode()">üìã Copy to Clipboard</button>
        <button class="btn-secondary" onclick="downloadCode()">‚¨áÔ∏è Download HTML</button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>‚öôÔ∏è Settings</h2>
        <button class="close-btn" onclick="closeSettings()">√ó</button>
      </div>
      
      <div class="form-group">
        <label>Admin Password</label>
        <input type="password" id="newPassword" placeholder="Enter new password">
        <button class="btn-primary btn-small" onclick="updatePassword()" style="margin-top: 8px;">Update Password</button>
      </div>

      <div class="section-divider"></div>

      <div class="form-group">
        <label>WebinarFuel API Bearer Token (Global)</label>
        <input type="text" id="globalBearerToken" placeholder="Dp2kG9Vucpyq5t5RVPqvDxfU" value="">
        <small>Set this once and it will be used for all forms automatically</small>
        <button class="btn-primary btn-small" onclick="saveBearerToken()" style="margin-top: 8px;">Save Bearer Token</button>
      </div>

      <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
        <button class="btn-secondary" onclick="closeSettings()">Close</button>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const DEFAULT_PASSWORD = 'admin123';
    const STORAGE_KEYS = {
      PASSWORD: 'wf_admin_password',
      FORMS: 'wf_forms',
      LOGGED_IN: 'wf_logged_in',
      ACTIVE_FORM: 'wf_active_form',
      BEARER_TOKEN: 'wf_bearer_token'
    };

    let currentForm = null;
    let forms = [];

    // Get or set the global bearer token
    function getBearerToken() {
      return localStorage.getItem(STORAGE_KEYS.BEARER_TOKEN) || '';
    }

    function setBearerToken(token) {
      localStorage.setItem(STORAGE_KEYS.BEARER_TOKEN, token);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadForms();
      checkAuth();
      
      // Allow Enter key to login
      document.getElementById('loginPassword').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') login();
      });
    });

    // Authentication
    function checkAuth() {
      const isLoggedIn = sessionStorage.getItem(STORAGE_KEYS.LOGGED_IN);
      if (isLoggedIn === 'true') {
        showDashboard();
      } else {
        showLogin();
      }
    }

    function login() {
      const password = document.getElementById('loginPassword').value;
      const storedPassword = localStorage.getItem(STORAGE_KEYS.PASSWORD) || DEFAULT_PASSWORD;
      
      if (password === storedPassword) {
        sessionStorage.setItem(STORAGE_KEYS.LOGGED_IN, 'true');
        showDashboard();
        showToast('Welcome back! üëã', 'success');
      } else {
        showToast('Incorrect password ‚ùå');
        document.getElementById('loginPassword').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem(STORAGE_KEYS.LOGGED_IN);
      showLogin();
      showToast('Logged out successfully');
    }

    function openSettings() {
      document.getElementById('globalBearerToken').value = getBearerToken();
      document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettings() {
      document.getElementById('settingsModal').classList.remove('active');
    }

    function updatePassword() {
      const newPassword = document.getElementById('newPassword').value;
      if (newPassword && newPassword.length >= 4) {
        localStorage.setItem(STORAGE_KEYS.PASSWORD, newPassword);
        document.getElementById('newPassword').value = '';
        showToast('Password updated! üîê', 'success');
      } else if (newPassword !== null && newPassword !== '') {
        showToast('Password must be at least 4 characters ‚ùå');
      }
    }

    function saveBearerToken() {
      const token = document.getElementById('globalBearerToken').value.trim();
      if (token) {
        setBearerToken(token);
        showToast('Bearer token saved! üéâ', 'success');
      } else {
        showToast('Please enter a bearer token ‚ùå');
      }
    }

    function showLogin() {
      document.getElementById('loginScreen').classList.remove('hidden');
      document.getElementById('adminDashboard').classList.add('hidden');
      document.getElementById('loginPassword').value = '';
    }

    function showDashboard() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminDashboard').classList.remove('hidden');
      renderFormsList();
      
      // Load last active form or show empty state
      const activeFormId = localStorage.getItem(STORAGE_KEYS.ACTIVE_FORM);
      if (activeFormId && forms.find(f => f.id === activeFormId)) {
        loadForm(activeFormId);
      } else if (forms.length > 0) {
        loadForm(forms[0].id);
      } else {
        showEmptyEditor();
      }
    }

    // Forms Management
    function loadForms() {
      const stored = localStorage.getItem(STORAGE_KEYS.FORMS);
      forms = stored ? JSON.parse(stored) : [];
    }

    function saveForms() {
      localStorage.setItem(STORAGE_KEYS.FORMS, JSON.stringify(forms));
    }

    function createNewForm() {
      const name = prompt('Enter form name:');
      if (!name) return;

      const newForm = {
        id: Date.now().toString(),
        name: name,
        infusionsoft_action: '',
        infusionsoft_xid: '',
        infusionsoft_form_name: '',
        wf_session_id: '',
        wf_widget_id: '',
        wf_widget_version: '',
        consent_id: 'inf_option_SMSConsent',
        button_text: 'üî• Reserve My Free Seat Now',
        created: new Date().toISOString()
      };

      forms.unshift(newForm);
      saveForms();
      renderFormsList();
      loadForm(newForm.id);
      showToast('Form created! ‚ú®', 'success');
    }

    function loadForm(formId) {
      currentForm = forms.find(f => f.id === formId);
      localStorage.setItem(STORAGE_KEYS.ACTIVE_FORM, formId);
      renderFormEditor();
      renderFormsList();
    }

    function saveCurrentForm() {
      if (!currentForm) return;

      const formData = {
        name: document.getElementById('formName').value,
        infusionsoft_action: document.getElementById('infusionsoftAction').value,
        infusionsoft_xid: document.getElementById('infusionsoftXid').value,
        infusionsoft_form_name: document.getElementById('infusionsoftFormName').value,
        wf_session_id: document.getElementById('wfSessionId').value,
        wf_widget_id: document.getElementById('wfWidgetId').value,
        wf_widget_version: document.getElementById('wfWidgetVersion').value,
        consent_id: document.getElementById('consentId').value,
        button_text: document.getElementById('buttonText').value
      };

      Object.assign(currentForm, formData);
      saveForms();
      renderFormsList();
      showToast('Form saved! üíæ', 'success');
    }

    function deleteCurrentForm() {
      if (!currentForm) return;
      
      if (!confirm(`Delete "${currentForm.name}"? This cannot be undone.`)) return;

      forms = forms.filter(f => f.id !== currentForm.id);
      saveForms();
      currentForm = null;
      localStorage.removeItem(STORAGE_KEYS.ACTIVE_FORM);
      renderFormsList();
      
      if (forms.length > 0) {
        loadForm(forms[0].id);
      } else {
        showEmptyEditor();
      }
      
      showToast('Form deleted üóëÔ∏è');
    }

    // Rendering
    function renderFormsList() {
      const container = document.getElementById('formsList');
      
      if (forms.length === 0) {
        container.innerHTML = '<div class="empty-state">No forms yet.<br>Click "+ New" to create one.</div>';
        return;
      }

      container.innerHTML = forms.map(form => `
        <div class="form-item ${currentForm && currentForm.id === form.id ? 'active' : ''}" 
             onclick="loadForm('${form.id}')">
          <h3>${escapeHtml(form.name)}</h3>
          <p>${form.wf_session_id ? 'Session: ' + form.wf_session_id : 'Not configured'}</p>
        </div>
      `).join('');
    }

    function renderFormEditor() {
      const container = document.getElementById('editorContent');
      
      container.innerHTML = `
        <h2>‚úèÔ∏è Edit Form: ${escapeHtml(currentForm.name)}</h2>
        
        <div class="form-group">
          <label>Form Name</label>
          <input type="text" id="formName" value="${escapeHtml(currentForm.name)}">
        </div>

        <div class="section-title">‚ö° Quick Import</div>
        
        <div class="form-group">
          <label>Paste Infusionsoft Form HTML</label>
          <textarea id="infusionsoftPaste" placeholder="Paste your entire Infusionsoft <form> HTML here and we'll extract the values automatically..." rows="4"></textarea>
          <button class="btn-secondary btn-small" onclick="extractInfusionsoft()" style="margin-top: 8px;">üîç Extract Infusionsoft Data</button>
        </div>

        <div class="form-group">
          <label>WebinarFuel Widget URL</label>
          <input type="url" id="webinarFuelUrl" placeholder="https://embed.webby.app/embed/viewers/...">
          <button class="btn-secondary btn-small" onclick="extractWebinarFuel()" style="margin-top: 8px;">üîç Extract WebinarFuel Data</button>
          <small>Paste the WebinarFuel embed script URL or widget page URL</small>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">üìß Infusionsoft Configuration</div>
        
        <div class="form-group">
          <label>Infusionsoft Form Action URL</label>
          <input type="url" id="infusionsoftAction" value="${escapeHtml(currentForm.infusionsoft_action)}" 
                 placeholder="https://yv932.infusionsoft.com/app/form/process/...">
          <small>The action URL from your Infusionsoft form</small>
        </div>

        <div class="form-group">
          <label>Infusionsoft Form XID</label>
          <input type="text" id="infusionsoftXid" value="${escapeHtml(currentForm.infusionsoft_xid)}" 
                 placeholder="0e88a9caa97c29d4c16c4bb07baa0bd2">
          <small>The unique form identifier (xid parameter)</small>
        </div>

        <div class="form-group">
          <label>Infusionsoft Form Name</label>
          <input type="text" id="infusionsoftFormName" value="${escapeHtml(currentForm.infusionsoft_form_name)}" 
                 placeholder="Web Form submitted">
          <small>The internal form name in Infusionsoft</small>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">üé• WebinarFuel Configuration</div>

        <div class="form-group">
          <label>WebinarFuel Session ID</label>
          <input type="text" id="wfSessionId" value="${escapeHtml(currentForm.wf_session_id)}" 
                 placeholder="68133">
          <small>The webinar session ID (unique per webinar)</small>
        </div>

        <div class="form-group">
          <label>WebinarFuel Widget ID</label>
          <input type="text" id="wfWidgetId" value="${escapeHtml(currentForm.wf_widget_id)}" 
                 placeholder="78139">
          <small>The widget ID for this webinar</small>
        </div>

        <div class="form-group">
          <label>WebinarFuel Widget Version</label>
          <input type="text" id="wfWidgetVersion" value="${escapeHtml(currentForm.wf_widget_version)}" 
                 placeholder="129684">
          <small>The widget version ID</small>
        </div>

        <div class="form-group" style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 2px solid #e5e7eb;">
          <label style="color: #6b7280;">WebinarFuel Bearer Token</label>
          <div style="color: #6b7280; font-size: 14px; margin-top: 5px;">
            ${getBearerToken() ? '‚úÖ Set globally in Settings' : '‚ö†Ô∏è Not set - Click Settings to configure'}
          </div>
          <small>Bearer token is now configured globally in Settings (‚öôÔ∏è button)</small>
        </div>

        <div class="section-divider"></div>
        <div class="section-title">üé® Customization</div>

        <div class="form-group">
          <label>SMS Consent Checkbox ID</label>
          <input type="text" id="consentId" value="${escapeHtml(currentForm.consent_id)}" 
                 placeholder="inf_option_SMSConsent">
          <small>The ID for the SMS consent checkbox</small>
        </div>

        <div class="form-group">
          <label>Submit Button Text</label>
          <input type="text" id="buttonText" value="${escapeHtml(currentForm.button_text)}" 
                 placeholder="üî• Reserve My Free Seat Now">
        </div>

        <div class="button-group">
          <button class="btn-primary" onclick="saveCurrentForm()">üíæ Save Form</button>
          <button class="btn-success" onclick="generateCode()">üöÄ Generate Code</button>
          <button class="btn-danger" onclick="deleteCurrentForm()">üóëÔ∏è Delete Form</button>
        </div>
      `;
    }

    function showEmptyEditor() {
      const container = document.getElementById('editorContent');
      container.innerHTML = `
        <div class="empty-state" style="padding: 100px 20px;">
          <h2 style="color: #9ca3af; margin-bottom: 20px;">No form selected</h2>
          <p>Select a form from the list or create a new one to get started.</p>
        </div>
      `;
    }

    // Code Generation
    function generateCode() {
      if (!currentForm) return;

      const bearerToken = getBearerToken();

      // Validation
      if (!bearerToken) {
        showToast('Please set Bearer Token in Settings first ‚ö†Ô∏è');
        openSettings();
        return;
      }

      if (!currentForm.wf_session_id || !currentForm.wf_widget_id || !currentForm.wf_widget_version) {
        showToast('Please fill in all WebinarFuel fields ‚ùå');
        return;
      }

      const code = generateEmbedCode(currentForm, bearerToken);
      document.getElementById('codePreview').textContent = code;
      document.getElementById('codeModal').classList.add('active');
    }

    function generateEmbedCode(form, bearerToken) {
      const formId = `inf_form_${form.infusionsoft_xid}`;
      
      return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webinar Registration - The Cash Flow Academy</title>
  <meta name="description" content="Register for our free webinar">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
</head>
<body>

<form accept-charset="UTF-8"
      action="${form.infusionsoft_action}"
      class="infusion-form"
      id="${formId}"
      method="POST"
      data-inf-form-id="${formId}"
      data-wf-session-id="${form.wf_session_id}"
      data-wf-widget-id="${form.wf_widget_id}"
      data-wf-widget-version="${form.wf_widget_version}"
      data-wf-widget-name="Embed"
      data-wf-bearer-token="${bearerToken}"
      data-consent-id="${form.consent_id}">`;
      data-wf-session-id="${form.wf_session_id}"
      data-wf-widget-id="${form.wf_widget_id}"
      data-wf-widget-version="${form.wf_widget_version}"
      data-wf-widget-name="Embed"
      data-wf-bearer-token="${form.wf_bearer_token}"
      data-consent-id="${form.consent_id}">

  <input name="inf_form_xid" type="hidden" value="${form.infusionsoft_xid}" />
  <input name="inf_form_name" type="hidden" value="${form.infusionsoft_form_name}" />
  <input name="infusionsoft_version" type="hidden" value="1.70.0.852640" />

  <!-- Floating field: First Name -->
  <div class="infusion-field float-field">
    <input id="inf_field_FirstName" name="inf_field_FirstName" type="text" autocomplete="given-name" />
    <label for="inf_field_FirstName">First Name</label>
  </div>

  <!-- Floating field: Last Name -->
  <div class="infusion-field float-field">
    <input id="inf_field_LastName" name="inf_field_LastName" type="text" autocomplete="family-name" />
    <label for="inf_field_LastName">Last Name</label>
  </div>

  <!-- Floating field: Email (required) -->
  <div class="infusion-field float-field">
    <input id="inf_field_Email" name="inf_field_Email" type="email" autocomplete="email" required />
    <label for="inf_field_Email">Email *</label>
  </div>

  <!-- Floating field: Mobile Phone -->
  <div class="infusion-field float-field">
    <input id="inf_field_Phone1" name="inf_field_Phone1" type="tel" autocomplete="tel" />
    <label for="inf_field_Phone1">Mobile Phone</label>
  </div>

  <!-- Consent checkbox -->
  <div class="infusion-field">
    <label class="sms-consent-row" for="${form.consent_id}">
      <input id="${form.consent_id}" name="${form.consent_id}" type="checkbox" value="3872" />
      <span class="sms-consent-text">
        By checking this box, I agree to receive text messages (such as reminders, updates, and promotional offers)
        from The Cash Flow Academy at the mobile number provided. Message and data rates may apply.
        Message frequency varies. Consent is not a condition of purchase. Reply STOP to unsubscribe.
      </span>
    </label>
  </div>

  <!-- Hidden UTM + fbclid fields -->
  <input name="inf_custom_GaContent" type="hidden" value="null" />
  <input name="inf_custom_GaSource" type="hidden" value="null" />
  <input name="inf_custom_GaMedium" type="hidden" value="null" />
  <input name="inf_custom_GaTerm" type="hidden" value="null" />
  <input name="inf_custom_GaCampaign" type="hidden" value="null" />
  <input name="inf_custom_GaCampaignID" type="hidden" value="null" />
  <input name="inf_custom_GaReferurl" type="hidden" value="null" />
  <input name="inf_custom_fbclid" type="hidden" value="null" />

  <div class="infusion-submit">
    <button id="inf_submit_btn" type="submit">${form.button_text}</button>
  </div>
</form>

<!-- Infusionsoft Scripts -->
<script src="https://yv932.infusionsoft.app/app/webTracking/getTrackingCode" type="text/javascript"><\/script>
<script src="https://yv932.infusionsoft.com/app/timezone/timezoneInputJs?xid=${form.infusionsoft_xid}" type="text/javascript"><\/script>
<script src="https://yv932.infusionsoft.com/js/jquery/jquery-3.3.1.js" type="text/javascript"><\/script>
<script src="https://yv932.infusionsoft.app/app/webform/overwriteRefererJs" type="text/javascript"><\/script>

<!-- Bridge Script -->
<script>
const _wf_getStoredOrURLParam = (param) => {
  try {
    const params = new URLSearchParams(window.location.search);
    let v = params.get(param);
    if (v && v !== 'null' && v.trim() !== '' && !v.startsWith('&')) return decodeURIComponent(v).trim();
    const stored = localStorage.getItem(param);
    if (stored && stored !== 'null' && stored.trim() !== '') return stored;
  } catch(e){}
  return null;
};
const _wf_persistIfPresent = (key) => {
  try {
    const params = new URLSearchParams(window.location.search);
    const val = params.get(key);
    if (val && val !== 'null' && val.trim() !== '') {
      localStorage.setItem(key, decodeURIComponent(val).trim());
    }
  } catch(e){}
  return _wf_getStoredOrURLParam(key);
};
const _wf_injectField = (name, value) => {
  const field = document.querySelector(\`input[name="\${name}"]\`);
  if (field) {
    field.value = (value ?? '').toString();
    console.log(\`[UTM] Set \${name} =\`, field.value);
  }
};
const _wf_normalizePhone = (raw) => {
  const s = (raw || '').replace(/[^\\d+]/g, '');
  const digits = s.replace(/\\D/g, '');
  if (s.startsWith('+')) return s;
  if (digits.length === 11 && digits.startsWith('1')) return '+' + digits;
  if (digits.length === 10) return '+1' + digits;
  return s || '';
};
const _wf_fetchWithTimeout = async (url, opts = {}, timeoutMs = 4000) => {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort(), timeoutMs);
  try {
    const res = await fetch(url, { ...opts, signal: controller.signal });
    clearTimeout(id);
    return res;
  } catch (e) {
    clearTimeout(id);
    throw e;
  }
};
const _wf_showConfigError = (formEl, missingKeys) => {
  const banner = document.createElement('div');
  banner.className = 'wf-config-error';
  banner.innerHTML = \`
    <strong>Configuration error:</strong> Missing required data attributes: 
    <code>\${missingKeys.map(k => 'data-wf-' + k.replace('wf','').replace(/^[A-Z]/,m=>m.toLowerCase())).join(', ')}</code>.
    Please set them on the <code>&lt;form&gt;</code> before enabling submissions.
  \`;
  formEl.prepend(banner);
  const btn = formEl.querySelector('#inf_submit_btn');
  if (btn) btn.disabled = true;
};

function initWFBridge(formEl) {
  if (!formEl) { console.error('[Bridge] No form element found.'); return; }

  const cfg = {
    formId: formEl.dataset.infFormId || formEl.id || '',
    wfSessionId: formEl.dataset.wfSessionId || '',
    wfWidgetId: formEl.dataset.wfWidgetId || '',
    wfWidgetVersion: formEl.dataset.wfWidgetVersion || '',
    wfWidgetName: formEl.dataset.wfWidgetName || '',
    wfBearerToken: formEl.dataset.wfBearerToken || '',
    consentId: formEl.dataset.consentId || ''
  };

  const requiredKeys = ['wfSessionId','wfWidgetId','wfWidgetVersion','wfBearerToken'];
  const missing = requiredKeys.filter(k => !cfg[k] || String(cfg[k]).trim() === '');
  if (missing.length) {
    console.error('[Bridge] Missing required config:', { missing, cfg });
    _wf_showConfigError(formEl, missing);
    return;
  }

  console.log('[Init] WF/Infusionsoft bridge loaded with config:', cfg);

  const floatInputs = formEl.querySelectorAll('.float-field input');
  const syncFloat = (inp) => ((inp.value || '').trim() !== '' ? inp.classList.add('has-value') : inp.classList.remove('has-value'));
  floatInputs.forEach(inp => {
    syncFloat(inp);
    inp.addEventListener('focus', () => inp.classList.add('is-focus'));
    inp.addEventListener('blur', () => inp.classList.remove('is-focus'));
    inp.addEventListener('input', () => syncFloat(inp));
  });

  const consentEl = cfg.consentId ? document.getElementById(cfg.consentId) : null;
  console.log('[Consent] Checkbox found:', !!consentEl);

  _wf_injectField('inf_custom_GaSource',     _wf_persistIfPresent('utm_source'));
  _wf_injectField('inf_custom_GaMedium',     _wf_persistIfPresent('utm_medium'));
  _wf_injectField('inf_custom_GaCampaign',   _wf_persistIfPresent('utm_campaign'));
  _wf_injectField('inf_custom_GaTerm',       _wf_persistIfPresent('utm_term'));
  _wf_injectField('inf_custom_GaContent',    _wf_persistIfPresent('utm_content'));
  _wf_injectField('inf_custom_GaCampaignID', _wf_persistIfPresent('utm_id'));
  _wf_injectField('inf_custom_fbclid',       _wf_persistIfPresent('fbclid'));
  _wf_injectField('inf_custom_GaReferurl',   document.referrer || '');

  let SUBMIT_LOCK = false;
  const submitBtn = document.getElementById('inf_submit_btn');

  const handleSubmit = async (ev) => {
    ev.preventDefault();
    if (SUBMIT_LOCK) { console.log('[Submit] Blocked duplicate submit'); return; }
    SUBMIT_LOCK = true;
    if (submitBtn) { submitBtn.disabled = true; submitBtn.dataset.label = submitBtn.textContent; submitBtn.textContent = 'Submitting‚Ä¶'; }

    const email     = document.getElementById('inf_field_Email').value.trim();
    const firstName = document.getElementById('inf_field_FirstName').value.trim();
    const lastName  = document.getElementById('inf_field_LastName').value.trim();
    const phone     = _wf_normalizePhone(document.getElementById('inf_field_Phone1').value.trim());
    const smsConsent = !!(consentEl && consentEl.checked);

    console.log('[Form Values]', { firstName, lastName, email, phoneNormalized: phone, smsConsent });

    if (!email || !/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {
      console.warn('[Validation] Invalid or missing email');
      alert('Please enter a valid email.');
      SUBMIT_LOCK = false;
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = submitBtn.dataset.label || 'Submit'; }
      return;
    }

    const resolvedSource = window.location.href;
    const utm_source     = _wf_getStoredOrURLParam('utm_source') || "";

    console.log('[Source Mapping]', { source: resolvedSource, utm_source });

    const payload = {
      version_id: cfg.wfWidgetVersion,
      recaptcha_action: "wf_verify_recaptcha",
      viewer: {
        webinar_session_id: cfg.wfSessionId,
        time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        email,
        first_name: firstName,
        last_name:  lastName,
        phone: smsConsent ? phone : "",
        lead: false,
        registration_source_widget_type: "embed",
        registration_source_widget_name: cfg.wfWidgetName || "embed",
        widget_id: cfg.wfWidgetId,
        widget_version_id: cfg.wfWidgetVersion,
        source:      resolvedSource,
        utm_source:  utm_source,
        utm_medium:  _wf_getStoredOrURLParam('utm_medium')   || "",
        utm_campaign:_wf_getStoredOrURLParam('utm_campaign') || "",
        utm_term:    _wf_getStoredOrURLParam('utm_term')     || "",
        utm_content: _wf_getStoredOrURLParam('utm_content')  || ""
      }
    };

    console.log('[WebinarFuel] Payload:', payload);

    try {
      const res = await _wf_fetchWithTimeout("https://embed.webby.app/embed/v2/viewers", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + cfg.wfBearerToken
        },
        body: JSON.stringify(payload)
      }, 4000);
      const data = await res.json().catch(() => ({}));
      if (data?.cid) { try { localStorage.setItem('_wf_cid', data.cid); } catch(e) {} }
      console.log('[WebinarFuel] Response:', data);
    } catch (err) {
      console.error('[WebinarFuel] Send failed (continuing):', err);
    }

    console.log('[Infusionsoft] Submitting form now‚Ä¶');
    (document.getElementById(cfg.formId) || formEl).submit();
  };

  formEl.addEventListener('submit', handleSubmit);
}

document.addEventListener('DOMContentLoaded', () => {
  const formEl = document.querySelector('form.infusion-form[data-wf-session-id][data-wf-widget-id][data-wf-widget-version][data-wf-bearer-token]');
  if (!formEl) {
    console.error('[Bridge] No configured form found.');
    const fallback = document.querySelector('form.infusion-form');
    if (fallback) _wf_showConfigError(fallback, ['wfSessionId','wfWidgetId','wfWidgetVersion','wfBearerToken']);
    return;
  }
  initWFBridge(formEl);
});
<\/script>

<style>
  #${formId} {
    max-width:560px; margin:0 auto;
    font-family:'Montserrat',sans-serif !important;
    text-align:left !important;
  }
  #${formId} .infusion-field { margin-bottom:16px; text-align:left !important; }

  #${formId} .wf-config-error {
    background:#FFF5F5; border:1px solid #F5C2C7; color:#842029;
    padding:10px 12px; border-radius:8px; margin-bottom:14px;
    font-size:14px;
  }
  #${formId} .wf-config-error code {
    background:#ffe3e3; padding:2px 6px; border-radius:6px;
  }

  #${formId} .float-field { position:relative; }
  #${formId} .float-field input {
    width:100%; padding:14px 12px 12px; border:1px solid #cfd4dc; border-radius:10px;
    font-size:16px; background:#fff; outline:none; transition:border-color .15s ease;
    position:relative; z-index:1; font-family:'Montserrat',sans-serif !important;
  }
  #${formId} .float-field input:focus { border-color:#F28C28; }
  #${formId} .float-field label {
    position:absolute; left:12px; top:50%; transform:translateY(-50%);
    background:#fff; padding:0 6px; color:#4b5563 !important; font-size:15px !important;
    font-family:'Montserrat',sans-serif !important; line-height:1; pointer-events:none;
    transition:all .15s ease; z-index:2; display:block !important; opacity:1 !important;
  }
  #${formId} .float-field input:focus + label,
  #${formId} .float-field input.has-value + label {
    top:-8px; transform:none; font-size:12px !important; color:#F28C28 !important;
  }

  #${formId} .sms-consent-row { 
    display:flex; align-items:flex-start; gap:10px; cursor:pointer; 
    font-family:'Montserrat',sans-serif !important; text-align:left !important;
  }
  #${formId} .sms-consent-row input[type="checkbox"] { width:16px; height:16px; margin-top:2px; }
  #${formId} .sms-consent-text { font-size:13px; line-height:1.35; color:#333; }

  #${formId} .infusion-submit button {
    width:100%; padding:12px 16px; border:none; border-radius:10px; background:#F28C28; color:#fff;
    font-size:17px; font-weight:700; font-family:'Montserrat',sans-serif !important;
    cursor:pointer; transition:background-color .2s ease, transform .1s ease;
  }
  #${formId} .infusion-submit button:hover:not(:disabled) { background:#e67c1f; transform:translateY(-1px); }
  #${formId} .infusion-submit button:disabled { opacity:.7; cursor:not-allowed; }

  #${formId} .input-error { border-color:#CF252D !important; }
  #${formId} .error-message { color:#CF252D; font-size:12px; margin-top:6px; }
</style>

</body>
</html>`;
    }

    function closeCodeModal() {
      document.getElementById('codeModal').classList.remove('active');
    }

    function copyCode() {
      const code = document.getElementById('codePreview').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showToast('Code copied to clipboard! üìã', 'success');
      }).catch(() => {
        showToast('Failed to copy code ‚ùå');
      });
    }

    function downloadCode() {
      const code = document.getElementById('codePreview').textContent;
      const blob = new Blob([code], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentForm.name.replace(/[^a-z0-9]/gi, '-').toLowerCase()}-registration.html`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Code downloaded! ‚¨áÔ∏è', 'success');
    }

    // Extraction Functions
    function extractInfusionsoft() {
      const html = document.getElementById('infusionsoftPaste').value;
      if (!html) {
        showToast('Please paste Infusionsoft form HTML first ‚ùå');
        return;
      }

      try {
        // Create temporary DOM to parse
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const form = doc.querySelector('form');

        if (!form) {
          showToast('No form found in pasted HTML ‚ùå');
          return;
        }

        // Extract action URL
        const action = form.getAttribute('action');
        if (action) {
          document.getElementById('infusionsoftAction').value = action;
        }

        // Extract XID
        const xidInput = form.querySelector('input[name="inf_form_xid"]');
        if (xidInput) {
          document.getElementById('infusionsoftXid').value = xidInput.value;
        }

        // Extract form name
        const nameInput = form.querySelector('input[name="inf_form_name"]');
        if (nameInput) {
          document.getElementById('infusionsoftFormName').value = nameInput.value;
        }

        // Extract consent checkbox ID (look for data-consent-id or long checkbox name)
        const consentId = form.dataset.consentId;
        if (consentId) {
          document.getElementById('consentId').value = consentId;
        } else {
          // Try to find checkbox with long name
          const checkbox = form.querySelector('input[type="checkbox"][name*="Bycheckingthisbox"]');
          if (checkbox) {
            document.getElementById('consentId').value = checkbox.id || checkbox.name;
          }
        }

        showToast('Infusionsoft data extracted! ‚ú®', 'success');
        
        // Clear the paste area
        document.getElementById('infusionsoftPaste').value = '';

      } catch (error) {
        console.error('Extract error:', error);
        showToast('Failed to extract data. Check the HTML format ‚ùå');
      }
    }

    function extractWebinarFuel() {
      const url = document.getElementById('webinarFuelUrl').value;
      if (!url) {
        showToast('Please enter a WebinarFuel URL first ‚ùå');
        return;
      }

      try {
        // Parse URL to extract parameters
        const urlObj = new URL(url);
        
        // Method 1: Extract from embed URL params (?widget_id=123&version_id=456...)
        const widgetId = urlObj.searchParams.get('widget_id');
        const versionId = urlObj.searchParams.get('version_id') || urlObj.searchParams.get('widget_version_id');
        const bearerToken = urlObj.searchParams.get('bearer_token') || urlObj.searchParams.get('token');

        if (widgetId) document.getElementById('wfWidgetId').value = widgetId;
        if (versionId) document.getElementById('wfWidgetVersion').value = versionId;
        
        // If bearer token found in URL, save it to global settings
        if (bearerToken && bearerToken !== getBearerToken()) {
          setBearerToken(bearerToken);
          showToast('Bearer token also saved to Settings! üîê', 'success');
        }

        // Method 2: Extract from path (/embed/viewers/[widget_id]/[version_id])
        const pathParts = urlObj.pathname.split('/').filter(p => p);
        if (pathParts.includes('viewers') && pathParts.length >= 3) {
          const viewersIndex = pathParts.indexOf('viewers');
          if (!widgetId && pathParts[viewersIndex + 1]) {
            document.getElementById('wfWidgetId').value = pathParts[viewersIndex + 1];
          }
          if (!versionId && pathParts[viewersIndex + 2]) {
            document.getElementById('wfWidgetVersion').value = pathParts[viewersIndex + 2];
          }
        }

        // Check if we got anything
        const extracted = !!(widgetId || versionId || document.getElementById('wfWidgetId').value);
        
        if (extracted) {
          showToast('WebinarFuel data extracted! ‚ú®', 'success');
          document.getElementById('webinarFuelUrl').value = '';
          renderFormEditor(); // Refresh to show bearer token status
        } else {
          showToast('Could not extract data from URL. Please check the format ‚ö†Ô∏è');
        }

      } catch (error) {
        console.error('URL parse error:', error);
        showToast('Invalid URL format ‚ùå');
      }
    }

    // Utilities
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text || '';
      return div.innerHTML;
    }

    function showToast(message, type = '') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
  </script>

</body>
</html>
