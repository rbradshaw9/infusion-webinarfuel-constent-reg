<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Webinar Registration - Generated by Webinar Bridge</title>
  <meta name="description" content="Register for our free webinar">
  <meta name="generator" content="Webinar Bridge v1.0.0 - Generated on {{TIMESTAMP}}">
  
  <!-- Montserrat Font -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet" />
  
  <style>
    /* Generated Registration Form Styles */
    
    /* Reset and base styles */
    * { box-sizing: border-box; }
    body {
      font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      background: #f8fafc;
      color: #334155;
    }
    
    /* Form container */
    .form-container {
      max-width: 560px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    
    /* Form styling */
    .infusion-form {
      width: 100%;
    }
    
    .infusion-field {
      margin-bottom: 20px;
      text-align: left;
    }
    
    /* Floating label fields */
    .float-field {
      position: relative;
    }
    
    .float-field input {
      width: 100%;
      padding: 16px 14px 14px;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      font-size: 16px;
      background: #fff;
      outline: none;
      transition: all 0.2s ease;
      font-family: 'Montserrat', sans-serif;
    }
    
    .float-field input:focus {
      border-color: #F28C28;
      box-shadow: 0 0 0 3px rgba(242, 140, 40, 0.1);
    }
    
    .float-field label {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      padding: 0 6px;
      color: #64748b;
      font-size: 15px;
      font-family: 'Montserrat', sans-serif;
      line-height: 1;
      pointer-events: none;
      transition: all 0.2s ease;
      z-index: 2;
      display: block;
      opacity: 1;
    }
    
    .float-field input:focus + label,
    .float-field input.has-value + label {
      top: -10px;
      transform: none;
      font-size: 13px;
      color: #F28C28;
      font-weight: 600;
    }
    
    /* Consent checkbox */
    .sms-consent-row {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      text-align: left;
      line-height: 1.5;
    }
    
    .sms-consent-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      margin-top: 3px;
      accent-color: #F28C28;
      cursor: pointer;
    }
    
    .sms-consent-text {
      font-size: 14px;
      color: #475569;
    }
    
    /* Submit button */
    .infusion-submit {
      margin-top: 24px;
    }
    
    .infusion-submit button {
      width: 100%;
      padding: 16px 20px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(135deg, #F28C28 0%, #e67c1f 100%);
      color: #fff;
      font-size: 18px;
      font-weight: 700;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }
    
    .infusion-submit button:hover:not(:disabled) {
      background: linear-gradient(135deg, #e67c1f 0%, #d16c0f 100%);
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(242, 140, 40, 0.3);
    }
    
    .infusion-submit button:active {
      transform: translateY(0);
    }
    
    .infusion-submit button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Error states */
    .input-error {
      border-color: #ef4444 !important;
    }
    
    .error-message {
      color: #ef4444;
      font-size: 13px;
      margin-top: 6px;
      font-weight: 500;
    }
    
    /* Config error banner */
    .wf-config-error {
      background: #fef2f2;
      border: 2px solid #fecaca;
      color: #b91c1c;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    .wf-config-error strong {
      display: block;
      margin-bottom: 8px;
    }
    
    .wf-config-error code {
      background: #fee2e2;
      padding: 2px 6px;
      border-radius: 6px;
      font-family: 'Monaco', 'Menlo', monospace;
    }
    
    /* Loading state */
    .loading {
      position: relative;
    }
    
    .loading::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s ease infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Responsive design */
    @media (max-width: 640px) {
      body {
        padding: 10px;
      }
      
      .form-container {
        padding: 20px;
        border-radius: 12px;
      }
      
      .float-field input {
        font-size: 16px; /* Prevent zoom on iOS */
      }
    }
  </style>
</head>
<body>
  <div class="form-container">
    {{FORM_HTML}}
  </div>

  <!-- Infusionsoft Scripts -->
  <script src="https://yv932.infusionsoft.app/app/webTracking/getTrackingCode" type="text/javascript"></script>
  <script src="https://yv932.infusionsoft.com/app/timezone/timezoneInputJs" type="text/javascript"></script>
  <script src="https://yv932.infusionsoft.com/js/jquery/jquery-3.3.1.js" type="text/javascript"></script>
  <script src="https://yv932.infusionsoft.app/app/webform/overwriteRefererJs" type="text/javascript"></script>

  <!-- Webinar Bridge Script -->
  <script>
    /** Enhanced Webinar Bridge Script - Generated {{TIMESTAMP}} **/
    
    // Utility functions
    const _wf_getStoredOrURLParam = (param) => {
      try {
        const params = new URLSearchParams(window.location.search);
        let v = params.get(param);
        if (v && v !== 'null' && v.trim() !== '' && !v.startsWith('&')) {
          return decodeURIComponent(v).trim();
        }
        const stored = localStorage.getItem(param);
        if (stored && stored !== 'null' && stored.trim() !== '') {
          return stored;
        }
      } catch(e) {
        console.warn('[Bridge] Parameter retrieval error:', e);
      }
      return null;
    };

    const _wf_persistIfPresent = (key) => {
      try {
        const params = new URLSearchParams(window.location.search);
        const val = params.get(key);
        if (val && val !== 'null' && val.trim() !== '') {
          localStorage.setItem(key, decodeURIComponent(val).trim());
        }
      } catch(e) {
        console.warn('[Bridge] Parameter persistence error:', e);
      }
      return _wf_getStoredOrURLParam(key);
    };

    const _wf_injectField = (name, value) => {
      const field = document.querySelector(`input[name="${name}"]`);
      if (field) {
        field.value = (value ?? '').toString();
        console.log(`[UTM] Set ${name} =`, field.value);
      }
    };

    const _wf_normalizePhone = (raw) => {
      const s = (raw || '').replace(/[^\d+]/g, '');
      const digits = s.replace(/\D/g, '');
      if (s.startsWith('+')) return s;
      if (digits.length === 11 && digits.startsWith('1')) return '+' + digits;
      if (digits.length === 10) return '+1' + digits;
      return s || '';
    };

    const _wf_fetchWithTimeout = async (url, opts = {}, timeoutMs = 5000) => {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), timeoutMs);
      try {
        const res = await fetch(url, { ...opts, signal: controller.signal });
        clearTimeout(id);
        return res;
      } catch (e) {
        clearTimeout(id);
        throw e;
      }
    };

    const _wf_showConfigError = (formEl, missingKeys) => {
      const banner = document.createElement('div');
      banner.className = 'wf-config-error';
      banner.innerHTML = `
        <strong>Configuration Error:</strong>
        Missing required WebinarFuel configuration: <code>${missingKeys.join(', ')}</code>.
        Please check your form setup.
      `;
      formEl.prepend(banner);
      const btn = formEl.querySelector('button[type="submit"]');
      if (btn) btn.disabled = true;
    };

    function initWFBridge(formEl) {
      if (!formEl) {
        console.error('[Bridge] No form element found.');
        return;
      }

      // Read configuration from data attributes
      const cfg = {
        formId: formEl.dataset.infFormId || formEl.id || '',
        wfSessionId: formEl.dataset.wfSessionId || '',
        wfWidgetId: formEl.dataset.wfWidgetId || '',
        wfWidgetVersion: formEl.dataset.wfWidgetVersion || '',
        wfWidgetName: formEl.dataset.wfWidgetName || 'Embed',
        wfBearerToken: formEl.dataset.wfBearerToken || '',
        consentId: formEl.dataset.consentId || ''
      };

      // Validate required configuration
      const requiredKeys = ['wfSessionId', 'wfWidgetId', 'wfWidgetVersion', 'wfBearerToken'];
      const missing = requiredKeys.filter(k => !cfg[k] || String(cfg[k]).trim() === '');
      
      if (missing.length) {
        console.error('[Bridge] Missing required configuration:', { missing, cfg });
        _wf_showConfigError(formEl, missing);
        return;
      }

      console.log('[Bridge] Initialized with configuration:', cfg);

      // Setup floating label behavior
      const floatInputs = formEl.querySelectorAll('.float-field input');
      const syncFloat = (inp) => {
        const hasValue = (inp.value || '').trim() !== '';
        inp.classList.toggle('has-value', hasValue);
      };

      floatInputs.forEach(inp => {
        syncFloat(inp);
        inp.addEventListener('focus', () => inp.classList.add('is-focus'));
        inp.addEventListener('blur', () => inp.classList.remove('is-focus'));
        inp.addEventListener('input', () => syncFloat(inp));
      });

      // Get consent checkbox
      const consentEl = cfg.consentId ? document.getElementById(cfg.consentId) : null;
      console.log('[Bridge] Consent checkbox found:', !!consentEl);

      // UTM parameter handling
      _wf_injectField('inf_custom_GaSource', _wf_persistIfPresent('utm_source'));
      _wf_injectField('inf_custom_GaMedium', _wf_persistIfPresent('utm_medium'));
      _wf_injectField('inf_custom_GaCampaign', _wf_persistIfPresent('utm_campaign'));
      _wf_injectField('inf_custom_GaTerm', _wf_persistIfPresent('utm_term'));
      _wf_injectField('inf_custom_GaContent', _wf_persistIfPresent('utm_content'));
      _wf_injectField('inf_custom_GaCampaignID', _wf_persistIfPresent('utm_id'));
      _wf_injectField('inf_custom_fbclid', _wf_persistIfPresent('fbclid'));
      _wf_injectField('inf_custom_GaReferurl', document.referrer || '');

      // Form submission handler
      let SUBMIT_LOCK = false;
      const submitBtn = formEl.querySelector('button[type="submit"]');

      const handleSubmit = async (ev) => {
        ev.preventDefault();
        
        if (SUBMIT_LOCK) {
          console.log('[Bridge] Duplicate submission blocked');
          return;
        }
        
        SUBMIT_LOCK = true;
        
        // Update button state
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.dataset.originalText = submitBtn.textContent;
          submitBtn.textContent = 'Submitting...';
          submitBtn.classList.add('loading');
        }

        try {
          // Get form data
          const emailEl = formEl.querySelector('input[name="inf_field_Email"]');
          const firstNameEl = formEl.querySelector('input[name="inf_field_FirstName"]');
          const lastNameEl = formEl.querySelector('input[name="inf_field_LastName"]');
          const phoneEl = formEl.querySelector('input[name="inf_field_Phone1"]');

          const email = emailEl?.value.trim() || '';
          const firstName = firstNameEl?.value.trim() || '';
          const lastName = lastNameEl?.value.trim() || '';
          const phone = _wf_normalizePhone(phoneEl?.value.trim() || '');
          const smsConsent = !!(consentEl && consentEl.checked);

          console.log('[Bridge] Form data:', { firstName, lastName, email, phone: phone ? '[PROVIDED]' : '[EMPTY]', smsConsent });

          // Validation
          if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
            throw new Error('Please enter a valid email address.');
          }

          // Prepare WebinarFuel payload
          const payload = {
            version_id: cfg.wfWidgetVersion,
            recaptcha_action: "wf_verify_recaptcha",
            viewer: {
              webinar_session_id: cfg.wfSessionId,
              time_zone: Intl.DateTimeFormat().resolvedOptions().timeZone,
              email,
              first_name: firstName,
              last_name: lastName,
              phone: smsConsent ? phone : "", // Only send phone if consent given
              lead: false,
              registration_source_widget_type: "embed",
              registration_source_widget_name: cfg.wfWidgetName,
              widget_id: cfg.wfWidgetId,
              widget_version_id: cfg.wfWidgetVersion,
              source: window.location.href,
              utm_source: _wf_getStoredOrURLParam('utm_source') || "",
              utm_medium: _wf_getStoredOrURLParam('utm_medium') || "",
              utm_campaign: _wf_getStoredOrURLParam('utm_campaign') || "",
              utm_term: _wf_getStoredOrURLParam('utm_term') || "",
              utm_content: _wf_getStoredOrURLParam('utm_content') || ""
            }
          };

          console.log('[Bridge] WebinarFuel payload prepared');

          // Submit to WebinarFuel
          try {
            const wfResponse = await _wf_fetchWithTimeout("https://embed.webby.app/embed/v2/viewers", {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + cfg.wfBearerToken
              },
              body: JSON.stringify(payload)
            }, 5000);

            const wfData = await wfResponse.json().catch(() => ({}));
            
            if (wfData?.cid) {
              try {
                localStorage.setItem('_wf_cid', wfData.cid);
              } catch(e) {
                console.warn('[Bridge] Could not store WebinarFuel CID');
              }
            }
            
            console.log('[Bridge] WebinarFuel submission successful');
          } catch (wfError) {
            console.error('[Bridge] WebinarFuel submission failed:', wfError.message);
            // Continue with Infusionsoft submission even if WebinarFuel fails
          }

          // Submit to Infusionsoft
          console.log('[Bridge] Submitting to Infusionsoft...');
          formEl.submit();

        } catch (error) {
          console.error('[Bridge] Submission error:', error);
          alert(error.message || 'An error occurred. Please try again.');
          
          // Reset form state
          SUBMIT_LOCK = false;
          if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.textContent = submitBtn.dataset.originalText || 'Submit';
            submitBtn.classList.remove('loading');
          }
        }
      };

      formEl.addEventListener('submit', handleSubmit);
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      const formEl = document.querySelector('form.infusion-form[data-wf-session-id][data-wf-widget-id][data-wf-widget-version][data-wf-bearer-token]');
      
      if (!formEl) {
        console.error('[Bridge] No properly configured form found.');
        const fallback = document.querySelector('form.infusion-form');
        if (fallback) {
          _wf_showConfigError(fallback, ['wfSessionId', 'wfWidgetId', 'wfWidgetVersion', 'wfBearerToken']);
        }
        return;
      }
      
      initWFBridge(formEl);
    });
  </script>
</body>
</html>